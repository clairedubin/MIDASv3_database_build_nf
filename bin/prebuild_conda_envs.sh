#!/usr/bin/env bash
# prebuild_conda_envs.sh
#
# Builds all conda environments used by main.nf into .conda_envs/ and writes
# conf/conda_envs.config so Nextflow uses the pre-built envs on the next run.
#
# Usage:
#   bash prebuild_conda_envs.sh            # build all envs
#   bash prebuild_conda_envs.sh --force    # rebuild even if env already exists
#
# To revert to on-the-fly env creation simply delete conf/conda_envs.config.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ENV_SRC_DIR="${SCRIPT_DIR}/env"
BUILT_ENV_DIR="${SCRIPT_DIR}/.conda_envs"
CONFIG_OUT="${SCRIPT_DIR}/conf/conda_envs.config"
FORCE=false

# ── Parse args ────────────────────────────────────────────────────────────────
for arg in "$@"; do
    case "${arg}" in
        --force) FORCE=true ;;
        *) echo "Unknown argument: ${arg}"; exit 1 ;;
    esac
done

# ── Verify conda is available ─────────────────────────────────────────────────
if ! command -v conda &>/dev/null; then
    echo "[ERROR] conda not found in PATH. Activate your base conda environment first."
    exit 1
fi

# ── Env definitions: <logical-name> → <yml-file> ──────────────────────────────
# Associative arrays aren't ordered in bash, so we use two parallel arrays so
# the build order is deterministic and easy to read.
ENV_NAMES=(
    python-bio
    vsearch
    hmmer
    hsblastn
    cdhit
    prokka
    eggnog
    genomad
    resfinder
)

declare -A ENV_YMLS=(
    [python-bio]="${ENV_SRC_DIR}/python-bio.yml"
    [vsearch]="${ENV_SRC_DIR}/vsearch.yml"
    [hmmer]="${ENV_SRC_DIR}/hmmer.yml"
    [hsblastn]="${ENV_SRC_DIR}/hsblastn.yml"
    [cdhit]="${ENV_SRC_DIR}/cdhit.yml"
    [prokka]="${ENV_SRC_DIR}/prokka.yml"
    [eggnog]="${ENV_SRC_DIR}/eggnog.yml"
    [genomad]="${ENV_SRC_DIR}/genomad.yml"
    [resfinder]="${ENV_SRC_DIR}/resfinder.yml"
)

# ── Build envs ────────────────────────────────────────────────────────────────
mkdir -p "${BUILT_ENV_DIR}"

for name in "${ENV_NAMES[@]}"; do
    yml="${ENV_YMLS[$name]}"
    prefix="${BUILT_ENV_DIR}/${name}"

    if [[ ! -f "${yml}" ]]; then
        echo "[WARN]  ${yml} not found — skipping '${name}'."
        continue
    fi

    if [[ -d "${prefix}" ]] && [[ "${FORCE}" == false ]]; then
        echo "[SKIP]  '${name}' already exists at ${prefix}"
    else
        if [[ -d "${prefix}" ]]; then
            echo "[REBUILD] Removing existing env '${name}'..."
            rm -rf "${prefix}"
        fi
        echo "[BUILD] Creating '${name}' from ${yml} ..."
        conda env create -f "${yml}" --prefix "${prefix}"
        echo "[DONE]  ${name} → ${prefix}"
    fi
done

# ── Write nextflow config ─────────────────────────────────────────────────────
mkdir -p "$(dirname "${CONFIG_OUT}")"

# Helper: emit an absolute path only when the env directory actually exists;
# otherwise omit the entry so the yml-level fallback in the process is used.
emit() {
    local process_name="${1}"
    local env_name="${2}"
    local prefix="${BUILT_ENV_DIR}/${env_name}"
    if [[ -d "${prefix}" ]]; then
        printf "    withName: '%-36s { conda = '%s' }\n" "${process_name}'" "${prefix}"
    else
        echo "    // '${process_name}' — pre-built env '${env_name}' not found; falling back to yml"
    fi
}

cat > "${CONFIG_OUT}" << HEADER
// ─────────────────────────────────────────────────────────────────────────────
// Auto-generated by prebuild_conda_envs.sh — do not edit manually.
// Delete this file to revert to on-the-fly conda env creation from yml files.
// Generated: $(date -u '+%Y-%m-%dT%H:%M:%SZ')
// ─────────────────────────────────────────────────────────────────────────────
process {
HEADER

emit  "AnnotateGenomes"             "prokka"      >> "${CONFIG_OUT}"
emit  "HMMMarkerSearch"             "hmmer"       >> "${CONFIG_OUT}"
emit  "BuildMarkerDB"               "hsblastn"    >> "${CONFIG_OUT}"
emit  "CleanCentroids"              "python-bio"  >> "${CONFIG_OUT}"
emit  "ParseCentroidInfo"           "python-bio"  >> "${CONFIG_OUT}"
emit  "RefineClusters"              "cdhit"       >> "${CONFIG_OUT}"
emit  "ReClusterCentroids"          "vsearch"     >> "${CONFIG_OUT}"
emit  "ParseReclusteredCentroidInfo" "python-bio" >> "${CONFIG_OUT}"
emit  "AugmentPangenomes"           "python-bio"  >> "${CONFIG_OUT}"
emit  "CalculateContigLength"       "python-bio"  >> "${CONFIG_OUT}"
emit  "RunEggNog"                   "eggnog"      >> "${CONFIG_OUT}"
emit  "RunGeNomad"                  "genomad"     >> "${CONFIG_OUT}"
emit  "RunResFinder"                "resfinder"   >> "${CONFIG_OUT}"
emit  "ParsePangenomeAnnotations"   "python-bio"  >> "${CONFIG_OUT}"
emit  "EnhancePangenome"            "python-bio"  >> "${CONFIG_OUT}"
emit  "ComputeChunks"               "python-bio"  >> "${CONFIG_OUT}"
emit  "ClusterCentroids"               "vsearch"  >> "${CONFIG_OUT}"
emit  "ClusterCentroidsLowerThresholds" "vsearch"  >> "${CONFIG_OUT}"
emit  "DownloadResFinderDB" "resfinder"  >> "${CONFIG_OUT}"
emit  "DownloadGeNomadDB" "genomad"  >> "${CONFIG_OUT}"

echo "}" >> "${CONFIG_OUT}"

echo ""
echo "────────────────────────────────────────────────"
echo " Pre-built env config written to:"
echo "   ${CONFIG_OUT}"
echo " Nextflow will use pre-built envs automatically."
echo " To revert: rm ${CONFIG_OUT}"
echo "────────────────────────────────────────────────"