process {
    maxRetries = 3
    cache = 'lenient'
    // conda = "${projectDir}/env/MIDASv3.yml"
    errorStrategy = { task.attempt < 5 ? 'retry' : 'ignore' }

    beforeScript = 'export CRYPTOGRAPHY_OPENSSL_NO_LEGACY=1'
}

conda { 
    enabled = true 
    cacheDir = ".env"  
} 

includeConfig 'conf/conda_envs.config'


// apptainer {
//     enabled = true
//     cacheDir = '/wynton/home/sirota/clairedubin/singularity_image/'
//     autoMounts = true
// }

env {
    PYTHONPATH = "${baseDir}/bin"
}

profiles {
  
  standard {
    executor {
        queueSize = 1000 
        submitRateLimit = '1/5sec'
    }

    process {

        executor = 'sge'
        penv = 'smp'
        
        withLabel: 'mem_very_high' {
          cpus = 16
          memory = { 4.GB * task.attempt }
          time = { 8.hour * task.attempt }
          clusterOptions = { " -S /bin/bash -R y -l h_vmem=${task.memory.toString().replaceAll(/[\sB]/,'')}" }
        }

        withLabel: 'mem_high' {
          cpus = 6
          memory = { 4.GB * task.attempt }
          time = { 6.hour * task.attempt }     
          clusterOptions = { " -S /bin/bash -R y -l h_vmem=${task.memory.toString().replaceAll(/[\sB]/,'')}" }
        }

        withLabel: 'mem_medium' {
          cpus = 2
          memory = { 8.GB * task.attempt }
          time = { 4.hour * task.attempt }  
          clusterOptions = { " -S /bin/bash -R y -l h_vmem=${task.memory.toString().replaceAll(/[\sB]/,'')}" }
        }

        withLabel: 'single_cpu' {
          cpus = 1
          memory = { 4.GB * task.attempt }
          time = { 4.hour * task.attempt }
          clusterOptions = { " -S /bin/bash -R y -l h_vmem=${task.memory.toString().replaceAll(/[\sB]/,'')}" }
        }
    }
  } 
}
